#!/bin/bash -e

function _get_conda_envs() {
  # Printed value will be list of Conda envs
  /opt/conda/bin/conda env list | tail -n +3 | head -n -1 | cut -d' ' -f1
}

function _is_env_present() {
  # $1 is the Conda env we are probing
  # Return value will be 0 if present (TRUE)

  # shellcheck disable=SC2155
  local _conda_envs=$(_get_conda_envs)
  echo "$_conda_envs" | grep -qw "$1"
  return $?
}

#check environment vars
if [[ -z "$MODEL_NAME" ]]; then

  echo "Failed to find required env vars MODEL_NAME"
  exit 1

else
  cd /home/model-server

  if [[ -x before-run ]]; then
    echo "Executing before-run script"
    ./before-run
  fi

  CONDA_ENV_NAME=${CONDA_ENV_NAME:-env}

  echo "starting microservice in environment '${CONDA_ENV_NAME}'"
  if [[ -v LAMBDA_MODE ]]; then
    echo "Starting serving with Lambda backend"
    if [ -z "${AWS_LAMBDA_RUNTIME_API}" ]; then
      exec /usr/local/bin/aws-lambda-rie /opt/conda/envs/"$CONDA_ENV_NAME"/bin/python -m awslambdaric handler.processor
    else
      exec /opt/conda/envs/"$CONDA_ENV_NAME"/bin/python -m awslambdaric handler.processor
    fi
  elif [[ -v SELDON_MODE ]]; then
    echo "Starting Seldon microservice"
    if [ -n "$PERSISTENCE" ]; then
      exec /opt/conda/envs/"$CONDA_ENV_NAME"/bin/seldon-core-microservice "$MODEL_NAME" --service-type "$SERVICE_TYPE" --persistence "$PERSISTENCE"
    else
      exec /opt/conda/envs/"$CONDA_ENV_NAME"/bin/seldon-core-microservice "$MODEL_NAME" --service-type "$SERVICE_TYPE"
    fi
  else
    echo "Starting serving with Sagemaker Backend"
    exec /opt/conda/envs/"$CONDA_ENV_NAME"/bin/python /home/model-server/dockerd-entrypoint.py "$MODEL_NAME" serve
  fi
fi
